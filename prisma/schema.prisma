generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                    String                 @id @default(cuid())
  name                  String
  dimensionsEnabled     Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  accounts              Account[]
  customers             Customer[]
  dimensionDefinitions  DimensionDefinition[]
  dimensionValues       DimensionValue[]
  inventoryTxns         InventoryTransaction[]
  inventoryBalances     InventoryBalance[]
  items                 Item[]
  journals              JournalEntry[]
  periods               Period[]
  purchaseOrders        PurchaseOrder[]
  salesOrders           SalesOrder[]
  users                 User[]
  vendors               Vendor[]
  warehouses            Warehouse[]
  transferOrders        TransferOrder[]
  reorderPoints         ReorderPoint[]
  containers            Container[]
  shipments             Shipment[]
}

model User {
  id             String       @id @default(cuid())
  organizationId String
  email          String       @unique
  name           String?
  role           String       @default("ADMIN")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Customer {
  id             String       @id @default(cuid())
  organizationId String
  number         String
  name           String
  email          String?
  phone          String?
  termsNetDays   Int          @default(30)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrders    SalesOrder[]

  @@unique([organizationId, number])
  @@index([organizationId])
}

model Vendor {
  id             String          @id @default(cuid())
  organizationId String
  number         String
  name           String
  email          String?
  phone          String?
  termsNetDays   Int             @default(30)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, number])
  @@index([organizationId])
}

model Item {
  id                 String                 @id @default(cuid())
  organizationId     String
  sku                String
  name               String
  type               ItemType               @default(STOCK)
  uom                String                 @default("EA")
  salesPrice         Decimal                @default(0)
  purchaseCost       Decimal                @default(0)
  isStocked          Boolean                @default(false)
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  inventoryTxns      InventoryTransaction[]
  inventoryBalances  InventoryBalance[]
  organization       Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrderLines PurchaseOrderLine[]
  salesOrderLines    SalesOrderLine[]
  reorderPoints      ReorderPoint[]
  transferOrderLines TransferOrderLine[]

  @@unique([organizationId, sku])
  @@index([organizationId])
}

model Warehouse {
  id                 String                 @id @default(cuid())
  organizationId     String
  code               String
  name               String
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  country            String?                @default("US")
  warehouseType      String?
  islandCode         String?
  isActive           Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  inventoryTxns      InventoryTransaction[]
  inventoryBalances  InventoryBalance[]
  purchaseOrderLines PurchaseOrderLine[]
  salesOrderLines    SalesOrderLine[]
  reorderPoints         ReorderPoint[]
  organization          Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transferOrdersFrom    TransferOrder[]        @relation("TransferOrderFrom")
  transferOrdersTo      TransferOrder[]        @relation("TransferOrderTo")
  containersOrigin      Container[]            @relation("ContainerOrigin")
  containersDestination Container[]            @relation("ContainerDestination")
  shipmentsOrigin       Shipment[]             @relation("ShipmentOrigin")
  shipmentsDestination  Shipment[]             @relation("ShipmentDestination")

  @@unique([organizationId, code])
  @@index([organizationId])
}

model SalesOrder {
  id             String           @id @default(cuid())
  organizationId String
  orderNo        String
  customerId     String
  orderDate      DateTime         @default(now())
  status         OrderStatus      @default(DRAFT)
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  customer       Customer         @relation(fields: [customerId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lines          SalesOrderLine[]

  @@unique([organizationId, orderNo])
  @@index([organizationId])
  @@index([customerId])
}

model SalesOrderLine {
  id           String     @id @default(cuid())
  salesOrderId String
  lineNo       Int
  itemId       String?
  description  String?
  quantity     Decimal    @default(0)
  unitPrice    Decimal    @default(0)
  warehouseId  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  item         Item?      @relation(fields: [itemId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  warehouse    Warehouse? @relation(fields: [warehouseId], references: [id])

  @@unique([salesOrderId, lineNo])
  @@index([itemId])
}

model PurchaseOrder {
  id             String              @id @default(cuid())
  organizationId String
  orderNo        String
  vendorId       String
  orderDate      DateTime            @default(now())
  status         OrderStatus         @default(DRAFT)
  notes          String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor         Vendor              @relation(fields: [vendorId], references: [id])
  lines          PurchaseOrderLine[]

  @@unique([organizationId, orderNo])
  @@index([organizationId])
  @@index([vendorId])
}

model PurchaseOrderLine {
  id              String        @id @default(cuid())
  purchaseOrderId String
  lineNo          Int
  itemId          String?
  description     String?
  quantity        Decimal       @default(0)
  unitCost        Decimal       @default(0)
  warehouseId     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  item            Item?         @relation(fields: [itemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  warehouse       Warehouse?    @relation(fields: [warehouseId], references: [id])

  @@unique([purchaseOrderId, lineNo])
  @@index([itemId])
}

model InventoryTransaction {
  id             String           @id @default(cuid())
  organizationId String
  txnType        InventoryTxnType
  itemId         String
  warehouseId    String
  quantity       Decimal
  unitCost       Decimal          @default(0)
  referenceType  String?
  referenceId    String?
  txnDate        DateTime         @default(now())
  createdAt      DateTime         @default(now())
  item           Item             @relation(fields: [itemId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  warehouse      Warehouse        @relation(fields: [warehouseId], references: [id])

  @@index([organizationId])
  @@index([itemId, warehouseId])
}

model Account {
  id             String        @id @default(cuid())
  organizationId String
  number         String
  name           String
  type           AccountType
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalLines   JournalLine[]

  @@unique([organizationId, number])
  @@index([organizationId])
}

model JournalEntry {
  id             String        @id @default(cuid())
  organizationId String
  journalNo      String
  description    String?
  postingDate    DateTime      @default(now())
  status         JournalStatus @default(DRAFT)
  periodId       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  period         Period?       @relation(fields: [periodId], references: [id])
  lines          JournalLine[]

  @@unique([organizationId, journalNo])
  @@index([organizationId])
  @@index([periodId])
}

model JournalLine {
  id             String       @id @default(cuid())
  journalEntryId String
  lineNo         Int
  accountId      String
  debit          Decimal      @default(0)
  credit         Decimal      @default(0)
  memo           String?
  dimensions     Json?
  createdAt      DateTime     @default(now())
  account        Account      @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@unique([journalEntryId, lineNo])
  @@index([accountId])
}

model Period {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  startDate      DateTime
  endDate        DateTime
  status         PeriodStatus   @default(OPEN)
  fiscalYear     Int
  periodNumber   Int
  closedAt       DateTime?
  closedBy       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([organizationId, fiscalYear, periodNumber])
  @@index([organizationId])
  @@index([status])
}

model InventoryBalance {
  id             String      @id @default(cuid())
  organizationId String
  itemId         String
  warehouseId    String
  onHandQty      Decimal     @default(0)
  allocatedQty   Decimal     @default(0)
  availableQty   Decimal     @default(0)
  inTransitQty   Decimal     @default(0)
  unitCost       Decimal?
  totalValue     Decimal?
  lastUpdated    DateTime    @updatedAt
  createdAt      DateTime    @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item           Item        @relation(fields: [itemId], references: [id])
  warehouse      Warehouse   @relation(fields: [warehouseId], references: [id])

  @@unique([organizationId, itemId, warehouseId])
  @@index([organizationId, itemId])
  @@index([warehouseId])
  @@map("inventory_balances")
}

model TransferOrder {
  id                  String              @id @default(cuid())
  organizationId      String
  transferOrderNumber String
  status              TransferOrderStatus @default(DRAFT)
  fromWarehouseId     String
  toWarehouseId       String
  orderDate           DateTime            @default(now())
  requestedShipDate   DateTime?
  actualShipDate      DateTime?
  expectedReceiptDate DateTime?
  actualReceiptDate   DateTime?
  shippingMethod      String?
  referenceNumber     String?
  containerId         String?
  shipmentId          String?
  notes               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fromWarehouse       Warehouse           @relation("TransferOrderFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse         Warehouse           @relation("TransferOrderTo", fields: [toWarehouseId], references: [id])
  container           Container?          @relation(fields: [containerId], references: [id])
  shipment            Shipment?           @relation(fields: [shipmentId], references: [id])
  lines               TransferOrderLine[]

  @@unique([organizationId, transferOrderNumber])
  @@index([organizationId])
  @@index([status])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([containerId])
  @@index([shipmentId])
  @@map("transfer_orders")
}

model TransferOrderLine {
  id              String        @id @default(cuid())
  transferOrderId String
  lineNumber      Int
  itemId          String
  orderedQty      Decimal
  shippedQty      Decimal       @default(0)
  receivedQty     Decimal       @default(0)
  uom             String        @default("EA")
  unitCost        Decimal?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  transferOrder   TransferOrder @relation(fields: [transferOrderId], references: [id], onDelete: Cascade)
  item            Item          @relation(fields: [itemId], references: [id])

  @@unique([transferOrderId, lineNumber])
  @@index([itemId])
  @@map("transfer_order_lines")
}

model ReorderPoint {
  id             String       @id @default(cuid())
  organizationId String
  itemId         String
  warehouseId    String
  minQty         Decimal
  maxQty         Decimal
  safetyStock    Decimal      @default(0)
  reorderQty     Decimal
  leadTimeDays   Int          @default(0)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item           Item         @relation(fields: [itemId], references: [id])
  warehouse      Warehouse    @relation(fields: [warehouseId], references: [id])

  @@unique([organizationId, itemId, warehouseId])
  @@index([organizationId])
  @@map("reorder_points")
}

model Container {
  id                  String           @id @default(cuid())
  organizationId      String
  containerNumber     String
  containerType       String           @default("40FT_FCL")
  status              ContainerStatus  @default(PLANNED)
  originWarehouseId   String
  destWarehouseId     String
  carrier             String?
  vesselName          String?
  voyageNumber        String?
  bookingNumber       String?
  sealNumber          String?
  plannedLoadDate     DateTime?
  actualLoadDate      DateTime?
  plannedDepartDate   DateTime?
  actualDepartDate    DateTime?
  plannedArrivalDate  DateTime?
  actualArrivalDate   DateTime?
  plannedUnloadDate   DateTime?
  actualUnloadDate    DateTime?
  estimatedTransitDays Int?
  notes               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  organization        Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  originWarehouse     Warehouse        @relation("ContainerOrigin", fields: [originWarehouseId], references: [id])
  destWarehouse       Warehouse        @relation("ContainerDestination", fields: [destWarehouseId], references: [id])
  transferOrders      TransferOrder[]

  @@unique([organizationId, containerNumber])
  @@index([organizationId])
  @@index([status])
  @@index([originWarehouseId])
  @@index([destWarehouseId])
  @@map("containers")
}

model Shipment {
  id                  String          @id @default(cuid())
  organizationId      String
  shipmentNumber      String
  shipmentType        String          @default("OCEAN_FCL")
  status              ShipmentStatus  @default(PLANNED)
  originWarehouseId   String
  destWarehouseId     String
  carrier             String?
  trackingNumber      String?
  plannedShipDate     DateTime?
  actualShipDate      DateTime?
  plannedDeliveryDate DateTime?
  actualDeliveryDate  DateTime?
  estimatedTransitDays Int?
  notes               String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  organization        Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  originWarehouse     Warehouse       @relation("ShipmentOrigin", fields: [originWarehouseId], references: [id])
  destWarehouse       Warehouse       @relation("ShipmentDestination", fields: [destWarehouseId], references: [id])
  transferOrders      TransferOrder[]

  @@unique([organizationId, shipmentNumber])
  @@index([organizationId])
  @@index([status])
  @@index([originWarehouseId])
  @@index([destWarehouseId])
  @@map("shipments")
}

enum ItemType {
  STOCK
  NON_STOCK
  SERVICE
}

enum OrderStatus {
  DRAFT
  RELEASED
  PARTIALLY_FULFILLED
  FULFILLED
  INVOICED
  CANCELLED
}

enum InventoryTxnType {
  RECEIPT
  ISSUE
  ADJUSTMENT
  TRANSFER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
}

enum PeriodStatus {
  OPEN
  CLOSED
  LOCKED
}

enum TransferOrderStatus {
  DRAFT
  RELEASED
  SHIPPED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum ContainerStatus {
  PLANNED
  LOADING
  LOADED
  IN_TRANSIT
  ARRIVED
  UNLOADING
  UNLOADED
  CANCELLED
}

enum ShipmentStatus {
  PLANNED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum DimensionType {
  DEPARTMENT
  PROJECT
  LOCATION
  ENTITY
  CUSTOMER
  VENDOR
  CUSTOM
}

model DimensionDefinition {
  id             String         @id @default(cuid())
  organizationId String
  code           String
  name           String
  type           DimensionType
  isRequired     Boolean        @default(false)
  isActive       Boolean        @default(true)
  accountTypes   Json?
  sortOrder      Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  values         DimensionValue[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model DimensionValue {
  id                   String              @id @default(cuid())
  organizationId       String
  dimensionDefinitionId String
  code                 String
  name                 String
  isActive             Boolean             @default(true)
  sortOrder            Int                 @default(0)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  organization         Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  dimensionDefinition  DimensionDefinition @relation(fields: [dimensionDefinitionId], references: [id], onDelete: Cascade)

  @@unique([dimensionDefinitionId, code])
  @@index([organizationId])
  @@index([dimensionDefinitionId])
}
