generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ItemType {
  STOCK
  NON_STOCK
  SERVICE
}

enum OrderStatus {
  DRAFT
  RELEASED
  PARTIALLY_FULFILLED
  FULFILLED
  INVOICED
  CANCELLED
}

enum InventoryTxnType {
  RECEIPT
  ISSUE
  ADJUSTMENT
  TRANSFER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  customers Customer[]
  vendors   Vendor[]
  items     Item[]
  warehouses Warehouse[]
  salesOrders SalesOrder[]
  purchaseOrders PurchaseOrder[]
  inventoryTxns InventoryTransaction[]
  accounts  Account[]
  journals  JournalEntry[]
}

model User {
  id             String   @id @default(cuid())
  organizationId String
  email          String   @unique
  name           String?
  role           String   @default("ADMIN")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Customer {
  id             String   @id @default(cuid())
  organizationId String
  number         String
  name           String
  email          String?
  phone          String?
  termsNetDays   Int      @default(30)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrders    SalesOrder[]

  @@unique([organizationId, number])
  @@index([organizationId])
}

model Vendor {
  id             String   @id @default(cuid())
  organizationId String
  number         String
  name           String
  email          String?
  phone          String?
  termsNetDays   Int      @default(30)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@unique([organizationId, number])
  @@index([organizationId])
}

model Item {
  id             String   @id @default(cuid())
  organizationId String
  sku            String
  name           String
  type           ItemType @default(STOCK)
  uom            String   @default("EA")
  salesPrice     Decimal  @default(0)
  purchaseCost   Decimal  @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrderLines SalesOrderLine[]
  purchaseOrderLines PurchaseOrderLine[]
  inventoryTxns  InventoryTransaction[]

  @@unique([organizationId, sku])
  @@index([organizationId])
}

model Warehouse {
  id             String   @id @default(cuid())
  organizationId String
  code           String
  name           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  salesOrderLines SalesOrderLine[]
  purchaseOrderLines PurchaseOrderLine[]
  inventoryTxns  InventoryTransaction[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model SalesOrder {
  id             String      @id @default(cuid())
  organizationId String
  orderNo        String
  customerId     String
  orderDate      DateTime    @default(now())
  status         OrderStatus @default(DRAFT)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  lines          SalesOrderLine[]

  @@unique([organizationId, orderNo])
  @@index([organizationId])
  @@index([customerId])
}

model SalesOrderLine {
  id            String   @id @default(cuid())
  salesOrderId  String
  lineNo        Int
  itemId        String?
  description   String?
  quantity      Decimal  @default(0)
  unitPrice     Decimal  @default(0)
  warehouseId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  salesOrder    SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  item          Item?      @relation(fields: [itemId], references: [id], onDelete: SetNull)
  warehouse     Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@unique([salesOrderId, lineNo])
  @@index([itemId])
}

model PurchaseOrder {
  id             String      @id @default(cuid())
  organizationId String
  orderNo        String
  vendorId       String
  orderDate      DateTime    @default(now())
  status         OrderStatus @default(DRAFT)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor         Vendor       @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  lines          PurchaseOrderLine[]

  @@unique([organizationId, orderNo])
  @@index([organizationId])
  @@index([vendorId])
}

model PurchaseOrderLine {
  id            String   @id @default(cuid())
  purchaseOrderId String
  lineNo        Int
  itemId        String?
  description   String?
  quantity      Decimal  @default(0)
  unitCost      Decimal  @default(0)
  warehouseId   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          Item?      @relation(fields: [itemId], references: [id], onDelete: SetNull)
  warehouse     Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  @@unique([purchaseOrderId, lineNo])
  @@index([itemId])
}

model InventoryTransaction {
  id             String          @id @default(cuid())
  organizationId String
  txnType        InventoryTxnType
  itemId         String
  warehouseId    String
  quantity       Decimal
  unitCost       Decimal @default(0)
  referenceType  String?
  referenceId    String?
  txnDate        DateTime @default(now())
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item           Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  warehouse      Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  @@index([organizationId])
  @@index([itemId, warehouseId])
}

model Account {
  id             String      @id @default(cuid())
  organizationId String
  number         String
  name           String
  type           AccountType
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalLines   JournalLine[]

  @@unique([organizationId, number])
  @@index([organizationId])
}

model JournalEntry {
  id             String        @id @default(cuid())
  organizationId String
  journalNo      String
  description    String?
  postingDate    DateTime      @default(now())
  status         JournalStatus @default(DRAFT)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lines          JournalLine[]

  @@unique([organizationId, journalNo])
  @@index([organizationId])
}

model JournalLine {
  id            String   @id @default(cuid())
  journalEntryId String
  lineNo        Int
  accountId     String
  debit         Decimal  @default(0)
  credit        Decimal  @default(0)
  memo          String?
  dimensions    Json?
  createdAt     DateTime @default(now())

  journalEntry  JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account       Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@unique([journalEntryId, lineNo])
  @@index([accountId])
}
